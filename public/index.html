<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{--primary-bg:#0f0e17;--accent:#ff8906;--glass-bg:rgba(255,255,255,0.05);--text:#fffffe}
*{box-sizing:border-box;font-family:'Inter',sans-serif;margin:0;padding:0}
body{background:var(--primary-bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center}
.hidden{display:none}
.auth-panel{background:var(--glass-bg);padding:2rem;border-radius:8px;backdrop-filter:blur(10px);width:320px}
.auth-panel h2{text-align:center;margin-bottom:1rem}
.auth-panel form{display:flex;flex-direction:column;gap:.5rem}
.auth-panel input{padding:.5rem;border:none;border-radius:4px;background:#fff;color:#000}
.auth-panel button{padding:.5rem;margin-top:.5rem;background:var(--accent);border:none;color:#000;font-weight:600;border-radius:4px;cursor:pointer}
.main{display:flex;height:100vh;width:100vw}
.sidebar{width:250px;background:rgba(0,0,0,.2);backdrop-filter:blur(10px);overflow-y:auto}
.sidebar ul{list-style:none;padding:0;margin:0}
.sidebar li{display:flex;align-items:center;padding:.5rem;border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer}
.sidebar img{width:32px;height:32px;border-radius:50%;margin-right:.5rem}
.chat{flex:1;display:flex;flex-direction:column}
.chat-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem;background:rgba(0,0,0,.3)}
.chat-header img{width:32px;height:32px;border-radius:50%;margin-right:.5rem}
.messages{flex:1;padding:1rem;overflow-y:auto}
.message{margin-bottom:.5rem;animation:messagePop .3s ease}
.message.me{text-align:right}
.message .bubble{display:inline-block;padding:.5rem 1rem;border-radius:12px;background:var(--accent);color:#000;max-width:60%}
.message.me .bubble{background:#fff}
.input-area{display:flex;align-items:center;padding:.5rem;background:rgba(0,0,0,.3)}
.input-area textarea{flex:1;resize:none;padding:.5rem;border-radius:4px;border:none;margin-right:.5rem}
.input-area button{background:var(--accent);border:none;padding:.5rem;border-radius:4px;cursor:pointer}
#toast-container{position:fixed;top:1rem;right:1rem;z-index:1000}
.toast{margin-bottom:.5rem;padding:.5rem 1rem;border-radius:4px;background:var(--accent);color:#000}
.call-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:2000}
.call-ui video{background:#000}
@keyframes messagePop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div id="auth" class="auth-panel">
<h2 id="auth-title">Connexion</h2>
<form id="login-form">
<input type="text" id="login-user" placeholder="Nom d'utilisateur" required>
<input type="password" id="login-pass" placeholder="Mot de passe" required>
<button type="submit">Se connecter</button>
</form>
<form id="register-form" class="hidden">
<input type="text" id="reg-name" placeholder="Nom" required>
<input type="text" id="reg-user" placeholder="Nom d'utilisateur" required>
<input type="password" id="reg-pass" placeholder="Mot de passe" required>
<input type="file" id="reg-avatar" accept="image/*">
<button type="submit">CrÃ©er un compte</button>
</form>
<p style="text-align:center;margin-top:.5rem"><a href="#" id="toggle-auth">S'inscrire</a></p>
</div>
<div id="app" class="main hidden" aria-hidden="true">
<aside class="sidebar" aria-label="Contacts"><ul id="user-list"></ul></aside>
<section class="chat" aria-label="Conversation">
<div class="chat-header"><div id="chat-info"></div><div><button id="call-audio" aria-label="Appel audio">ðŸ“ž</button> <button id="call-video" aria-label="Appel vidÃ©o">ðŸŽ¥</button></div></div>
<div class="messages" id="messages" aria-live="polite"></div>
<form id="msg-form" class="input-area" autocomplete="off">
<textarea id="msg-input" rows="1" aria-label="Message"></textarea>
<input type="file" id="file-input" class="hidden">
<button type="button" id="attach-btn" aria-label="Joindre"><i class="fa fa-paperclip"></i></button>
<button type="submit" aria-label="Envoyer">Envoyer</button>
</form>
</section>
</div>
<div id="toast-container" role="region" aria-live="polite"></div>
<div id="call-preview" class="call-overlay hidden" aria-hidden="true"></div>
<div id="call-active" class="call-overlay hidden" aria-hidden="true"></div>
<audio id="msg-sound" src="" preload="auto"></audio>
<script src="/socket.io/socket.io.js"></script>
<script>
const Utils=function(){return{formatDate(d){const date=new Date(d);const today=new Date();return date.toDateString()===today.toDateString()?date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):date.toLocaleString();},toast(msg,type='info'){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className='toast';t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),4e3);},scrollBottom(el){el.scrollTop=el.scrollHeight;}}}();
const SocketModule=function(){let socket;const listeners={};return{init(token){socket=io({auth:{token}});socket.on('users-updated',u=>listeners.users&&listeners.users(u));socket.on('new-message',m=>listeners.message&&listeners.message(m));socket.on('webrtc-offer',d=>listeners.offer&&listeners.offer(d));socket.on('webrtc-answer',d=>listeners.answer&&listeners.answer(d));socket.on('webrtc-ice-candidate',d=>listeners.candidate&&listeners.candidate(d));socket.on('end-call',d=>listeners.end&&listeners.end(d));},emit(evt,data,cb){socket.emit(evt,data,cb);},on(evt,fn){listeners[evt]=fn;}}}();
const AuthModule=function(){const loginF=document.getElementById('login-form');const regF=document.getElementById('register-form');const toggle=document.getElementById('toggle-auth');const authPanel=document.getElementById('auth');const app=document.getElementById('app');let registering=false;toggle.addEventListener('click',e=>{e.preventDefault();registering=!registering;loginF.classList.toggle('hidden',registering);regF.classList.toggle('hidden',!registering);document.getElementById('auth-title').textContent=registering?'Inscription':'Connexion';toggle.textContent=registering?'Se connecter':'S\'inscrire';});loginF.addEventListener('submit',async e=>{e.preventDefault();const username=loginF['login-user'].value.trim();const password=loginF['login-pass'].value;if(!username||password.length<6){Utils.toast('Champs invalides','error');return;}const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});const d=await r.json();if(r.ok){localStorage.token=d.token;localStorage.user=JSON.stringify(d.user);startApp();}else Utils.toast(d.error||'Erreur','error');});regF.addEventListener('submit',async e=>{e.preventDefault();const username=regF['reg-user'].value.trim();const name=regF['reg-name'].value.trim();const password=regF['reg-pass'].value;const avatar=regF['reg-avatar'].files[0];if(!username||!name||password.length<6){Utils.toast('Champs invalides','error');return;}const r=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,name})});const d=await r.json();if(r.ok){if(avatar){const fd=new FormData();fd.append('avatar',avatar);await fetch('/api/upload-avatar',{method:'POST',headers:{Authorization:'Bearer '+d.token},body:fd});}localStorage.token=d.token;localStorage.user=JSON.stringify(d.user);startApp();}else Utils.toast(d.error||'Erreur','error');});function startApp(){authPanel.classList.add('hidden');app.classList.remove('hidden');app.removeAttribute('aria-hidden');ChatModule.init();}}
();
const ChatModule=function(){const user=JSON.parse(localStorage.user||'null');const token=localStorage.token;const list=document.getElementById('user-list');const messagesEl=document.getElementById('messages');const chatInfo=document.getElementById('chat-info');const msgForm=document.getElementById('msg-form');const msgInput=document.getElementById('msg-input');const attachBtn=document.getElementById('attach-btn');const fileInput=document.getElementById('file-input');let current='';SocketModule.init(token);SocketModule.on('users',renderUsers);SocketModule.on('message',receiveMsg);msgForm.addEventListener('submit',sendMsg);attachBtn.addEventListener('click',()=>fileInput.click());fileInput.addEventListener('change',sendFile);list.addEventListener('click',e=>{const li=e.target.closest('li');if(!li)return;current=li.dataset.username;chatInfo.textContent=li.dataset.name;messagesEl.innerHTML='';fetchMessages();SocketModule.emit('mark-messages-read',{sender:current},()=>{});});function renderUsers(users){list.innerHTML='';users.filter(u=>u!==user.username).forEach(u=>{const li=document.createElement('li');li.dataset.username=u;li.dataset.name=u;li.innerHTML='<img src="https://i.pravatar.cc/50?u='+u+'" alt="">'+u;list.appendChild(li);});}async function fetchMessages(){const r=await fetch('/api/messages?partner='+current,{headers:{Authorization:'Bearer '+token}});const data=await r.json();data.forEach(m=>renderMessage(m));Utils.scrollBottom(messagesEl);}function renderMessage(m){const div=document.createElement('div');div.className='message'+(m.sender===user.username?' me':'');const bubble=document.createElement('div');bubble.className='bubble';if(m.type==='image'){const img=document.createElement('img');img.src=m.fileUrl;img.style.maxWidth='200px';img.alt='';bubble.appendChild(img);}else if(m.type==='file'){const link=document.createElement('a');link.href=m.fileUrl;link.textContent=m.content;link.download='';bubble.appendChild(link);}else bubble.textContent=m.content;div.appendChild(bubble);messagesEl.appendChild(div);}function receiveMsg(m){if(m.sender===current){renderMessage(m);Utils.scrollBottom(messagesEl);}if(document.hidden)document.getElementById('msg-sound').play();}function sendMsg(e){e.preventDefault();if(!current)return;const content=msgInput.value.trim();if(!content)return;SocketModule.emit('send-message',{recipient:current,content},res=>{if(res.success){renderMessage({sender:user.username,content,type:'text'});msgInput.value='';Utils.scrollBottom(messagesEl);}else Utils.toast('Erreur envoi','error');});}async function sendFile(){const file=fileInput.files[0];if(!file)return;if(file.size>10*1024*1024){Utils.toast('Fichier trop lourd','error');return;}const fd=new FormData();fd.append('file',file);fd.append('recipient',current);const r=await fetch('/api/upload-file',{method:'POST',headers:{Authorization:'Bearer '+token},body:fd});const d=await r.json();if(r.ok){SocketModule.emit('send-message',{recipient:current,content:file.name,type:d.type},res=>{if(res.success){renderMessage({sender:user.username,content:file.name,type:d.type,fileUrl:d.url});Utils.scrollBottom(messagesEl);}else Utils.toast('Erreur upload','error');});}else Utils.toast(d.error,'error');fileInput.value='';}return{init(){if(!token||!user){location.reload();return;}fetch('/api/messages?partner='+user.username,{headers:{Authorization:'Bearer '+token}});SocketModule.on('users',renderUsers);SocketModule.on('message',receiveMsg);}}}();
const WebRTCModule=function(){const preview=document.getElementById('call-preview');const active=document.getElementById('call-active');let local,remote,pc;function showPreview(user,video){preview.innerHTML='<div><video autoplay muted></video><p>Appeler '+user+'</p><button id="call-ok">Appeler</button><button id="call-cancel">Annuler</button></div>';preview.classList.remove('hidden');const v=preview.querySelector('video');navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(s=>{v.srcObject=s;local=s;preview.querySelector('#call-cancel').onclick=()=>{s.getTracks().forEach(t=>t.stop());preview.classList.add('hidden');};preview.querySelector('#call-ok').onclick=()=>{startCall(user);};});}
function startCall(user){preview.classList.add('hidden');active.innerHTML='<div><video id="remote" autoplay></video><video id="local" autoplay muted style="width:100px;position:absolute;bottom:10px;right:10px"></video><button id="hangup">Raccrocher</button></div>';active.classList.remove('hidden');pc=new RTCPeerConnection();local.getTracks().forEach(t=>pc.addTrack(t,local));pc.ontrack=e=>{remote=e.streams[0];active.querySelector('#remote').srcObject=remote;};pc.onicecandidate=e=>{if(e.candidate)SocketModule.emit('webrtc-ice-candidate',{recipient:user,candidate:e.candidate});};SocketModule.emit('webrtc-offer',{recipient:user,offer:null});active.querySelector('#hangup').onclick=end;}
function end(){active.classList.add('hidden');if(local)local.getTracks().forEach(t=>t.stop());if(remote)remote.getTracks().forEach(t=>t.stop());if(pc)pc.close();SocketModule.emit('end-call',{recipient:null});}
SocketModule.on('offer',d=>{});SocketModule.on('answer',d=>{});SocketModule.on('candidate',d=>{});SocketModule.on('end',d=>end());return{call:user=>showPreview(user)}}();
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{});});}
document.addEventListener('DOMContentLoaded',()=>{if(localStorage.token&&localStorage.user){document.getElementById('auth').classList.add('hidden');document.getElementById('app').classList.remove('hidden');ChatModule.init();}});
</script>
</body>
</html>
